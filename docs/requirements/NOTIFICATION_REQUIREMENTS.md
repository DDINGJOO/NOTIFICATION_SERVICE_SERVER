# Notification Service - 비즈니스 요구사항

---

## 개요

### 서비스 목적
MSA 환경에서 다른 서비스들의 알림 발송 요청을 중앙에서 처리하는 통합 알림 서비스

### 비즈니스 목표
1. 다양한 알림 채널(이메일, SMS, 앱 푸시, 인앱 알림)의 통합 관리
2. 사용자 수신 동의 기반의 법적 준수 알림 발송
3. 발송 이력 관리를 통한 추적성 확보
4. 기존 Mail Server 기능의 완전한 대체

### 기존 시스템 호환성
- 기존 Mail Server의 `email-confirm-request` Kafka 토픽 유지
- `EmailConfirmEvent` 스키마 그대로 사용

---

## 알림 채널

### 지원 채널

| 채널 | 외부 연동 | 용도 |
|------|-----------|------|
| **이메일** | Gmail SMTP | 본인인증, 예약확인, 마케팅 |
| **SMS** | Solapi API | 본인인증, 예약확인, 마케팅 |
| **앱 푸시** | FCM (Firebase Cloud Messaging) | 실시간 알림, 마케팅 |
| **인앱 알림** | 자체 구현 (미정) | 서비스 내 알림 |

### 채널별 요구사항

#### 이메일
- Gmail SMTP를 통한 발송 (기존 Mail Server와 동일)
- HTML 템플릿 지원
- 발송자 주소: 설정 가능

#### SMS
- Solapi API 연동
- 단문(SMS), 장문(LMS), 멀티미디어(MMS) 지원 고려
- 발신번호 사전 등록 필요

#### 앱 푸시
- FCM을 통한 Android/iOS 통합 발송
- 사용자별 FCM 토큰 관리 필요
- 푸시 알림 제목, 본문, 데이터 페이로드 지원

#### 인앱 알림
- 전달 방식 미정 (WebSocket/SSE 또는 폴링)
- 읽음 상태 관리
- 알림 목록 조회 기능

---

## 알림 유형

### 유형 분류

| 유형 | 수신 동의 | 야간 발송 | 설명 | 예시 |
|------|-----------|-----------|------|------|
| **트랜잭션** | 불필요 | 허용 | 서비스 이용에 필수적인 알림 | 본인인증, 비밀번호 재설정, 결제 완료 |
| **서비스** | 선택적 | 허용 | 서비스 관련 안내 | 예약 확인, 주문 상태 변경, 배송 안내 |
| **광고/마케팅** | 필수 | 동의 시만 | 프로모션, 이벤트 안내 | 할인 쿠폰, 이벤트 안내, 뉴스레터 |

### 유형별 처리 규칙

#### 트랜잭션 알림
- 수신 동의 확인 **불필요**
- 즉시 발송 (동기 처리 권장)
- 야간(21시~08시) 발송 **허용**
- 실패 시 재시도 필수

#### 서비스 알림
- 서비스 알림 수신 동의 확인 (선택적)
- 비동기 발송 가능
- 야간 발송 **허용**

#### 광고/마케팅 알림
- 광고성 정보 수신 동의 **필수** 확인
- 야간(21시~08시) 수신 동의 **별도 확인**
- 비동기 발송 (대량 발송 고려)
- 법적 요구사항:
  - 제목에 "(광고)" 표기
  - 수신 거부 방법 안내 포함

---

## 수신 동의 관리

### 동의 정보 수신
- User Service에서 Kafka 이벤트로 동의 정보 수신
- 회원가입, 이용약관 수정 시 이벤트 발행
- Notification Service 자체 DB에 저장

### 동의 항목

| 항목 | 설명 | 기본값 |
|------|------|--------|
| **서비스 알림 수신** | 예약 확인, 주문 상태 등 서비스 관련 알림 | 동의 |
| **광고성 정보 수신** | 마케팅, 프로모션 관련 알림 | 미동의 |
| **야간 광고 수신** | 21시~08시 광고성 정보 수신 | 미동의 |

### 동의 확인 로직

```
알림 발송 요청
    ↓
알림 유형 확인
    ↓
┌─ 트랜잭션 → 즉시 발송
│
├─ 서비스 → 서비스 알림 동의 확인 → 동의 시 발송
│
└─ 광고/마케팅 → 광고 수신 동의 확인
                    ↓
                야간 시간대?
                    ↓
                ┌─ Yes → 야간 수신 동의 확인 → 동의 시 발송
                └─ No → 발송
```

### 야간 시간대 정의
- **시작**: 21:00 (KST)
- **종료**: 08:00 (KST)
- 타임존: Asia/Seoul 기준

---

## 통신 방식

### 동기 처리 (REST API)
**사용 케이스:**
- 본인인증 SMS/이메일 (즉시 발송 필요)
- 결제 완료 알림
- 비밀번호 재설정

**특징:**
- 요청 후 발송 완료까지 대기
- 발송 결과 즉시 응답
- 타임아웃 설정 필요

### 비동기 처리 (Kafka)
**사용 케이스:**
- 예약 확인 알림
- 대량 마케팅 발송
- 주문 상태 변경 알림

**특징:**
- 요청 후 즉시 응답 (수락됨)
- 발송 결과는 별도 확인 (발송 이력 조회)
- 처리량 조절 가능

### 기존 Kafka 토픽 호환

| 토픽명 | 용도 | 처리 방식 |
|--------|------|----------|
| `email-confirm-request` | 이메일 인증 발송 | 기존과 동일하게 처리 |

---

## 외부 연동 사양

### Gmail SMTP
- **Host**: smtp.gmail.com
- **Port**: 587
- **인증**: 앱 비밀번호 사용
- **보안**: STARTTLS

### Solapi
- **API 버전**: v4
- **인증**: API Key, API Secret
- **지원 메시지 유형**: SMS, LMS, MMS
- **발신번호**: 사전 등록 필요

### FCM (Firebase Cloud Messaging)
- **인증**: Service Account JSON
- **API**: HTTP v1 API
- **지원 플랫폼**: Android, iOS
- **토큰 관리**: 사용자별 FCM 토큰 저장 필요

---

## 발송 이력 관리

### 저장 항목

| 항목 | 설명 |
|------|------|
| **발송 ID** | 고유 식별자 |
| **수신자** | 이메일, 전화번호, 사용자 ID 등 |
| **채널** | EMAIL, SMS, PUSH, IN_APP |
| **알림 유형** | TRANSACTION, SERVICE, MARKETING |
| **발송 시각** | 발송 요청 시각 |
| **발송 상태** | PENDING, SENT, FAILED, DELIVERED |
| **실패 사유** | 실패 시 에러 메시지 |
| **재시도 횟수** | 재시도 수행 횟수 |
| **메타데이터** | 채널별 추가 정보 (JSON) |

### 보관 기간
- 발송 이력: 최소 6개월 (법적 요구사항 고려)
- 상세 로그: 1개월

### 통계/조회 요구사항
- 기간별 발송 통계
- 채널별/유형별 성공률
- 실패 원인 분석

---

## 재시도 정책

### 재시도 대상
- 네트워크 오류
- 외부 서비스 일시적 장애
- 타임아웃

### 재시도 제외 대상
- 잘못된 수신자 정보 (Invalid Recipient)
- 수신 거부 상태
- 인증 오류

### 재시도 전략 (권장)
| 횟수 | 대기 시간 |
|------|----------|
| 1차 | 1분 후 |
| 2차 | 5분 후 |
| 3차 | 15분 후 |

- 최대 재시도 횟수: 3회
- 재시도 방식: Exponential Backoff 권장

---

## 관리자 기능 (추후 확장)

### 발송 이력 조회
- 기간별 검색
- 채널/유형별 필터
- 수신자 검색
- 발송 상태 필터

### 통계 대시보드
- 일별/주별/월별 발송량
- 채널별 성공률
- 실패 원인 Top 10

### 수동 발송
- 관리자가 직접 알림 발송
- 테스트 발송 기능

---

## 비기능 요구사항

### 성능
- 동기 발송: 응답 시간 5초 이내
- 비동기 발송: 수락 응답 100ms 이내
- 대량 발송: 분당 1,000건 이상 처리 가능

### 가용성
- 서비스 가용성: 99.9% 이상
- 외부 서비스 장애 시 재시도를 통한 복구

### 확장성
- 수평 확장 가능한 구조
- 채널 추가 시 최소 변경으로 대응

### 보안
- 개인정보(이메일, 전화번호) 암호화 저장
- API 인증/인가 적용
- 감사 로그 기록

---

## 용어 정의

| 용어 | 정의 |
|------|------|
| **트랜잭션 알림** | 서비스 이용에 필수적인 알림 (인증, 결제 등) |
| **서비스 알림** | 서비스 관련 안내 (예약, 주문 상태 등) |
| **광고성 알림** | 마케팅, 프로모션 목적의 알림 |
| **야간 시간대** | 21:00 ~ 08:00 (KST) |
| **수신 동의** | 알림 수신에 대한 사용자의 명시적 동의 |

---

**Last Updated**: 2025-12-11
